import { betterAuth } from 'better-auth';
import { drizzleAdapter } from 'better-auth/adapters/drizzle';
import { nextCookies } from 'better-auth/next-js';
import { db } from '../db';
import { oneTap, magicLink } from 'better-auth/plugins';
import nodemailer from 'nodemailer';
import fs from 'fs';
import path from 'path';
import { headers } from 'next/headers';

// Get IP address from Vercel headers with fallback
async function getIP() {
  const headersList = await headers();
  const forwardedFor = headersList.get('x-forwarded-for');
  const realIP = headersList.get('x-real-ip');
  const vercelForwardedFor = headersList.get('x-vercel-forwarded-for');

  if (forwardedFor) {
    return forwardedFor.split(',')[0]?.trim() || 'unknown ip';
  }

  if (realIP) {
    return realIP;
  }

  if (vercelForwardedFor) {
    return vercelForwardedFor.split(',')[0]?.trim() || 'unknown ip';
  }

  return 'unknown ip';
}

// Get location from Vercel headers with fallback
async function getLocation() {
  const headersList = await headers();
  const city = headersList.get('x-vercel-ip-city');
  const country = headersList.get('x-vercel-ip-country');
  const region = headersList.get('x-vercel-ip-country-region');

  if (city && country) {
    return { city, country: country, region: region || '' };
  }

  return { city: 'unknown', country: 'unknown', region: '' };
}

// Email sending function
async function sendMagicLinkEmail({ email, url }: { email: string; token: string; url: string }) {
  const emailServer = process.env.EMAIL_SERVER;
  if (!emailServer) {
    throw new Error('EMAIL_SERVER environment variable is not set');
  }

  const emailUrl = new URL(emailServer);

  const transporter = nodemailer.createTransport({
    host: emailUrl.hostname,
    port: parseInt(emailUrl.port),
    secure: emailUrl.port === '465',
    auth: {
      user: decodeURIComponent(emailUrl.username),
      pass: decodeURIComponent(emailUrl.password),
    },
  });

  const templatePath = path.join(process.cwd(), 'src', 'lib', 'templates', 'email.html');
  let emailTemplate = fs.readFileSync(templatePath, 'utf-8');

  // Get IP and location data
  const ip = await getIP();
  const { city, country } = await getLocation();

  // Replace template variables
  emailTemplate = emailTemplate.replace(/\{\{EMAIL\}\}/g, email);
  emailTemplate = emailTemplate.replace(/\{\{URL\}\}/g, url);
  emailTemplate = emailTemplate.replace(/\{\{IP\}\}/g, ip);

  const locationInfo = city !== 'unknown' && country !== 'unknown' ? ` <!-- -->located in<!-- --> <span style="color:rgb(0,0,0)">${city}, ${country}</span>` : '';
  emailTemplate = emailTemplate.replace(/\{\{LOCATION_INFO\}\}/g, locationInfo);

  const textFallback = `Your login link for Authenticator

You've requested to log in to Authenticator with the following email address (${email})

Login to Authenticator: ${url}

This link will only be valid for the next 15 minutes.

This code was sent from ${ip}${city !== 'unknown' && country !== 'unknown' ? ` located in ${city}, ${country}` : ''}. If you were not expecting this email, you can ignore this email.

aruu.meÂ® 2025`;

  await transporter.sendMail({
    from: process.env.EMAIL_FROM || 'no-reply.authenticator@tunn.cc',
    to: email,
    subject: 'Your login link to Authenticator',
    html: emailTemplate,
    text: textFallback,
    attachments: [
      {
        cid: 'authenticator.logo',
        filename: 'authenticator-logo.png',
        encoding: 'base64',
        contentType: 'image/png',
        contentDisposition: 'inline',
        content: `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`,
      },
    ],
  });
}

export const auth = betterAuth({
  database: drizzleAdapter(db, {
    provider: 'pg',
  }),
  emailAndPassword: {
    enabled: false,
  },
  socialProviders: {
    google: {
      clientId: process.env.GOOGLE_CLIENT_ID as string,
      clientSecret: process.env.GOOGLE_CLIENT_SECRET as string,
    },
  },

  trustedOrigins: ['localhost:3000', 'authenticator.tunn.cc'],

  plugins: [
    nextCookies(),
    oneTap(),
    magicLink({
      sendMagicLink: sendMagicLinkEmail,
      expiresIn: 300,
    }),
  ],
});
